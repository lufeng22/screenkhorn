%!TEX root = main.tex

\section{Regularized discrete OT} % (fold)
\label{sec:regularized_discrete_ot}

We briefly expose in this section the setup of OT between two discrete measures. We then consider the case when those distributions are only available through a finite number of samples, that is $\mu = \sum_{i=1}^n \mu_i \delta_{x_i} \in \Sigma_n$ and $\nu = \sum_{j=1}^m \nu_i \delta_{y_j} \in \Sigma_m$, where $\Sigma_n$ is the probability simplex with $n$ bins, namely the set of probability vectors in $\R_+^n$, i.e., $\Sigma_n = \{w \in \R_+^n: \sum_{i=1}^n w_i = 1\}.$
We denote their probabilistic couplings set as $\Pi(\mu, \nu) = \{P \in \R_+^{n\times m}, P\mathbf{1}_m = \mu, P^\top \mathbf{1}_n = \nu\}.$ 
\paragraph{Sinkhorn divergence.}

Computing OT distance between the two discrete measures $\mu$ and $\nu$  amounts to solving a linear problem~\citep{kantorovich1942} given by
\begin{equation*}
  \label{monge-kantorovich}
  \mathcal{S}(\mu, \nu) =  \min_{P\in \Pi(\mu, \nu)} \inr{C, P},
\end{equation*}
where $P= (P_{ij}) \in \R^{n\times m}$ is called the transportation plan, namely each entry $P_{ij}$ represents the fraction of mass moving from $x_i$ to $y_j$, and $C= (C_{ij}) \in \R^{n\times m}$ is a cost matrix comprised of nonnegative elements and related to the energy needed to move a probability mass from $x_i$ to $y_j$. 
The entropic regularization of OT distances~\citep{cuturinips13} relies on the addition of a penalty term as follows:
\begin{equation}
\label{sinkhorn-primal}
  \mathcal{S}_\eta(\mu, \nu) =  \min_{P\in \Pi(\mu, \nu)} \{\inr{C, P} - \eta H(P)\},
\end{equation}
where $\eta > 0$ is a regularization parameter. We refer to $\mathcal{S}_\eta(\mu, \nu) $ as the \emph{Sinkhorn divergence}~\citep{cuturinips13}.

\paragraph{Dual of Sinkhorn divergence.}

Below we provide the derivation of the dual problem for the regularized OT problem~\eqref{sinkhorn-primal}. Towards this end, we begin with writing its Lagrangian dual function:
\begin{equation*}
  \mathscr{L}(P,w, z) = \inr{C,P} + \eta \inr{\log P, P} + \inr{w, P\mathbf{1}_m - \mu} + \inr{z,P^\top \mathbf{1}_n - \nu}.
\end{equation*}
The dual of Sinkhorn divergence can be derived by solving $\min_{P \in \R_+^{n\times m}}\mathscr{L}(P,w, z)$. It is easy to check that objective function $P\mapsto \mathscr{L}(P,w, z)$ is strongly convex and differentiable. Hence, one can solve the latter minimum by setting $\nabla_P \mathscr{L}(P,w, z)$ to $\mathbf{0}_{n\times m}$. Therefore, we get $  P^\star_{ij} = \exp\big(- \frac{1}{\eta} (w_i + z_j + C_{ij}) - 1\big), 
$ for all $i=1, \ldots, n$ and $j=1, \ldots, m$. Plugging this solution,  and setting the change of variables $u = -w/\eta - 1/2$ and $v = - z/\eta - 1/2$, the dual problem is given by
\begin{equation}
\label{sinkhorn-dual}
\min_{u \in \R^n, v\in\R^m}\big\{\Psi(u,v):= \mathbf{1}_n^\top B(u,v)\mathbf{1}_m - \inr{u, \mu} - \inr{v, \nu} \big\},
\end{equation}
where $B(u,v) := \Delta(e^{u}) K \Delta(e^{v})$ and $K := e^{-C/\eta}$ stands for the Gibbs kernel associated to the cost matrix $C$. 
We refer to problem~\eqref{sinkhorn-dual} as the \emph{dual of Sinkhorn divergence}. Then, the optimal solution $P^\star$ of the primal problem~\eqref{sinkhorn-primal} takes the form $P^\star = \Delta(e^{u^\star}) K \Delta(e^{v^\star})$
where the couple $(u^\star, v^\star)$ satisfies:
\begin{align*}
\label{sinkhorn-dual}
  (u^\star, v^\star) &= \argmin_{u \in \R^{n}, v\in \R^m} \{\Psi(u,v)\}.
\end{align*}
Note that the matrices $\Delta(e^{u^\star})$ and $\Delta(e^{v^\star})$ are unique up to a constant factor~\citep{sinkhorn1967}. Moreover, $P^\star$ can be solved efficiently by iterative Bregman projections~\citep{benamou2015IterativeBP} referred to as Sinkhorn iterations, and the method is referred to as \textsc{Sinkhorn} algorithm which, recently, has been proven to achieve a near-$\bigO(n^2)$ complexity~\citep{altschulernips17}.

% section regularized_discrete_ot (end)